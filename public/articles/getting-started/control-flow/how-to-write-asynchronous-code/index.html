
<html>
<head>
  <script type="text/javascript">var _sf_startpt=(new Date()).getTime()</script>
  <link rel="stylesheet" href="/css/nodedocs.css" type="text/css" media="screen" title="no title" charset="utf-8">
  <link rel="stylesheet" href="/css/highlight/github.css" type="text/css" media="screen" title="no title" charset="utf-8">
</head>
<body>
  <header>
    <div class="link"><a href="http://github.com/nodejitsu/docs">Edit this page on GitHub</a></div>
    <div class="title">docs.nodejitsu.com</div>
  </header>

  <div id="mask"></div>
  <div id="toc"><ul><li><a href="/articles/advanced">advanced</a><ul><li><a href="/articles/advanced/buffers">buffers</a><ul><li><a href="/articles/advanced/buffers/how-to-use-buffers">how to use buffers</a></li></ul></li><li><a href="/articles/advanced/streams">streams</a><ul><li><a href="/articles/advanced/streams/how-to-use-fs-create-read-stream">how to use fs create read stream</a></li><li><a href="/articles/advanced/streams/how-to-use-fs-create-write-stream">how to use fs create write stream</a></li><li><a href="/articles/advanced/streams/how-to-use-stream-pipe">how to use stream pipe</a></li><li><a href="/articles/advanced/streams/what-are-streams">what are streams</a></li></ul></li></ul></li><li><a href="/articles/child-processes">child processes</a><ul><li><a href="/articles/child-processes/how-to-spawn-a-child-process">how to spawn a child process</a></li></ul></li><li><a href="/articles/command-line">command line</a><ul><li><a href="/articles/command-line/how-to-get-colors-on-the-command-line">how to get colors on the command line</a></li><li><a href="/articles/command-line/how-to-parse-command-line-arguments">how to parse command line arguments</a></li><li><a href="/articles/command-line/how-to-prompt-for-command-line-input">how to prompt for command line input</a></li></ul></li><li><a href="/articles/cryptography">cryptography</a><ul><li><a href="/articles/cryptography/how-to-use-crypto-module">how to use crypto module</a></li><li><a href="/articles/cryptography/how-to-use-the-tls-module">how to use the tls module</a></li></ul></li><li><a href="/articles/errors">errors</a><ul><li><a href="/articles/errors/what-are-the-error-conventions">what are the error conventions</a></li><li><a href="/articles/errors/what-is-the-error-object">what is the error object</a></li><li><a href="/articles/errors/what-is-try-catch">what is try catch</a></li></ul></li><li><a href="/articles/file-system">file system</a><ul><li><a href="/articles/file-system/how-to-read-files-in-nodejs">how to read files in nodejs</a></li><li><a href="/articles/file-system/how-to-search-files-and-directories-in-nodejs">how to search files and directories in nodejs</a></li><li><a href="/articles/file-system/how-to-store-local-config-data">how to store local config data</a></li><li><a href="/articles/file-system/how-to-use-the-path-module">how to use the path module</a></li><li><a href="/articles/file-system/how-to-write-files-in-nodejs">how to write files in nodejs</a></li></ul></li><li><a href="/articles/getting-started">getting started</a><ul><li><a href="/articles/getting-started/control-flow">control flow</a><ul><li><a href="/articles/getting-started/control-flow/how-to-write-asynchronous-code">how to write asynchronous code</a></li><li><a href="/articles/getting-started/control-flow/what-are-callbacks">what are callbacks</a></li><li><a href="/articles/getting-started/control-flow/what-are-event-emitters">what are event emitters</a></li></ul></li><li><a href="/articles/getting-started/globals-in-node-js">globals in node js</a></li><li><a href="/articles/getting-started/how-to-debug-nodejs-applications">how to debug nodejs applications</a></li><li><a href="/articles/getting-started/how-to-use-util-inspect">how to use util inspect</a></li><li><a href="/articles/getting-started/npm">npm</a><ul><li><a href="/articles/getting-started/npm/how-to-access-module-package-info">how to access module package info</a></li><li><a href="/articles/getting-started/npm/what-is-npm">what is npm</a></li><li><a href="/articles/getting-started/npm/what-is-the-file-package-json">what is the file package json</a></li></ul></li><li><a href="/articles/getting-started/the-console-module">the console module</a></li><li><a href="/articles/getting-started/the-process-module">the process module</a></li><li><a href="/articles/getting-started/what-is-require">what is require</a></li></ul></li><li><a href="/articles/HTTP">HTTP</a><ul><li><a href="/articles/HTTP/clients">clients</a><ul><li><a href="/articles/HTTP/clients/how-to-access-query-string-parameters">how to access query string parameters</a></li><li><a href="/articles/HTTP/clients/how-to-create-a-HTTP-request">how to create a HTTP request</a></li></ul></li><li><a href="/articles/HTTP/servers">servers</a><ul><li><a href="/articles/HTTP/servers/how-to-create-a-HTTP-server">how to create a HTTP server</a></li><li><a href="/articles/HTTP/servers/how-to-create-a-HTTPS-server">how to create a HTTPS server</a></li><li><a href="/articles/HTTP/servers/how-to-read-POST-data">how to read POST data</a></li><li><a href="/articles/HTTP/servers/how-to-serve-static-files">how to serve static files</a></li></ul></li></ul></li><li><a href="/articles/javascript-conventions">javascript conventions</a><ul><li><a href="/articles/javascript-conventions/how-to-create-default-parameters-for-functions">how to create default parameters for functions</a></li><li><a href="/articles/javascript-conventions/what-are-the-built-in-timer-functions">what are the built in timer functions</a></li><li><a href="/articles/javascript-conventions/what-are-truthy-and-falsy-values">what are truthy and falsy values</a></li><li><a href="/articles/javascript-conventions/what-is-json">what is json</a></li><li><a href="/articles/javascript-conventions/what-is-the-arguments-object">what is the arguments object</a></li></ul></li><li><a href="/articles/REPL">REPL</a><ul><li><a href="/articles/REPL/how-to-create-a-custom-repl">how to create a custom repl</a></li><li><a href="/articles/REPL/how-to-use-nodejs-repl">how to use nodejs repl</a></li></ul></li></ul></div>
  <div id="article">
    <div id="metadata">
      <h1 class="title">How to write asynchronous code</h1>
      <div class="date">Fri Aug 26 2011 03:08:50 GMT-0700 (PST)</div>
      <div class="author">nico</div>
      <div>
        
      <a href="/articles" class="breadcrumb">articles</a><a href="/articles/getting-started" class="breadcrumb">getting-started</a><a href="/articles/getting-started/control-flow" class="breadcrumb">control-flow</a><a href="/articles/getting-started/control-flow/how-to-write-asynchronous-code" class="breadcrumb">how-to-write-asynchronous-code</a></div>
      <!--
        <div class="tags"></div>
        <div class="difficulty"></div>
      -->
    </div>
    <div id="content"><p>Javascript is an asynchronous language, in contrast to many synchronous languages like PHP, Ruby, Python, Perl, C, etc.  There are a number of important things to be aware of when learning to write asynchronous code - otherwise, you will often find your code executing in extremely unexpected ways.  Take this (general) rule to heart:</p>

<h3>Use the asynchronous functions, avoid the synchronous ones!</h3>

<p>Many of the functions in Node.js core have both synchronous and asynchronous versions. Under most circumstances, it will be far better for you to use the asynchronous functions - otherwise, why are you using Node.js?</p>

<p>As a quick example comparing and contrasting the two, using <code>fs.readFile</code>:</p>

<pre><code>fs = require(<span class="string">'fs'</span>);

fs.readFile(<span class="string">'example.file'</span>, <span class="string">'utf8'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(err, data)</span> {</span>
    <span class="keyword">if</span> (err) {
      <span class="keyword">return</span> console.log(err);
    }
    console.log(data);
});

<span class="comment">//====================</span>

<span class="keyword">var</span> data = fs.readFileSync(<span class="string">'example.file'</span>,<span class="string">'utf8'</span>);
console.log(data);</code></pre>

<p>Just looking at these two blocks of code, the synchronous version appears to be more concise. However, the asynchronous version is more complicated for a very good reason. In the synchronous version, the world is paused until the file is finished reading - your process will just sit there, waiting for the OS (which handles all file system tasks).</p>

<p>The asynchronous version, on the other hand, does not stop time - instead, the callback function gets called when the file is finished reading. This leaves your process free to execute other code in the meantime.</p>

<p>When only reading a file or two, or saving something quickly, the difference between synchronous and asynchronous file I/O can be quite small. On the other hand, though, when you have multiple requests coming in per second that require file or database IO, trying to do that IO synchronously would be quite thoroughly disastrous for performance.</p>

<h3>Callbacks</h3>

<p>Callbacks are a basic idiom in node.js for asynchronous operations. When most people talk about callbacks, they mean the a fuction that is passed as the last parameter to an asynchronous function. The callback is then later called with any return value or error message that the function produced. For more details, see the article on <a href="/what-are-callbacks">callbacks</a></p>

<h3>Event Emitters</h3>

<p>Event Emitters are another basic idiom in node.js. A constructor is provided in Node.js core: <code><span class="identifier"><span class="keyword">require</span></span>(<span class="string">'events'</span>).<span class="constant">EventEmitter</span></code>. An Event Emitter is typically used when there will be multiple parts to the response (since usually you only want to call a callback once). For more details, see the article on <a href="/what-are-event-emitters">EventEmitters</a></p>

<h3>A gotcha with asynchronous code</h3>

<p>A common mistake in asynchronous code with javascript is to write code that does something like this:</p>

<pre><code> <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) {
   setTimeout(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
     console.log(i);
   }, i);
 }</code></pre>

<p>The unexpected output is then:</p>

<pre><code>5
5
5
5
5</code></pre>

<p>The reason this happens is because each timeout is created and then <code>i</code> is incremented. Then when the callback is called, it looks for the value of <code>i</code> and it is 5. The solution is to create a closure so that the current value of <code>i</code> is stored. For example:</p>

<pre><code> <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) {
   (<span class="function"><span class="keyword">function</span><span class="params">(i)</span> {</span>
     setTimeout(<span class="function"><span class="keyword">function</span> <span class="params">()</span> {</span>
       console.log(i);
     }, i);
   })(i);</code></pre>

<p>This gives the proper output:</p>

<pre><code>0
1
2
3
4</code></pre></div>
  </div>
  <script type="text/javascript" charset="utf-8" src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"></script>
  <script type="text/javascript" charset="utf-8" src="/js/index.js"></script>
  <script type="text/javascript">
  var _sf_async_config={uid:11119,domain:"docs.nodejitsu.com"};
  (function(){
    function loadChartbeat() {
      window._sf_endpt=(new Date()).getTime();
      var e = document.createElement('script');
      e.setAttribute('language', 'javascript');
      e.setAttribute('type', 'text/javascript');
      e.setAttribute('src',
         (("https:" == document.location.protocol) ? "https://a248.e.akamai.net/chartbeat.download.akamai.com/102508/" : "http://static.chartbeat.com/") +
         "js/chartbeat.js");
      document.body.appendChild(e);
    }
    var oldonload = window.onload;
    window.onload = (typeof window.onload != 'function') ?
       loadChartbeat : function() { oldonload(); loadChartbeat(); };
  })();
  </script>
</body>
</html>